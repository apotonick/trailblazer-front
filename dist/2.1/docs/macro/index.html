<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>
    <title>Trailblazer</title>
    <meta content="width=device-width,initial-scale=1" name="viewport"/>
    
    
    <link rel="stylesheet" href="/assets/tailwind-8f15cbd7f2c8c766d3adfa9f7e4b840e9220fb11a8435f33193f89a76b1564c2.css" />
<link rel="stylesheet" href="/assets/inter-font-8c3e82affb176f4bca9616b838d906343d1251adc8408efe02cf2b1e4fcf2bc4.css" />
    <link rel="stylesheet" href="/assets/application-e90144030d3ddedb521195c82273d47776f7f85012b6cc8d95c64466591b600f.css" />
    <script>pageIdentifier = "docs";</script>
    <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-e668100add93b10dcecaea50f9d1e2e5b6cbd64bf8d0bbd950e7f01a22373d01.js",
    "anchor-js": "/assets/anchor-js-821952d04abcd941bb3541822cd1c1f0234e5168bef1f9b2a050868af608aa5a.js",
    "navigations": "/assets/navigations-27f57ba888008b48256d2635e15bd2f0be7a039b32c8e84140da87596cbf9547.js",
    "highlight.js/lib/core": "https://ga.jspm.io/npm:highlight.js@11.8.0/es/core.js",
    "highlight.js/lib/languages/ruby": "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/es/languages/ruby.min.js",
    "jquery": "/assets/jquery-9292661fe0d8c5ef2ef35f5ca64d541d70c87e9f6d7f2716d646591a295b7f36.js",
    "jquery.parallax-scroll": "/assets/jquery.parallax-scroll-a50d2125650d18a234bc9a3eea0a0f1c40871f3ccfba877d0eae70e690955825.js"
  }
}</script>
<link rel="modulepreload" href="/assets/application-e668100add93b10dcecaea50f9d1e2e5b6cbd64bf8d0bbd950e7f01a22373d01.js">
<link rel="modulepreload" href="/assets/anchor-js-821952d04abcd941bb3541822cd1c1f0234e5168bef1f9b2a050868af608aa5a.js">
<script src="/assets/es-module-shims.min-4ca9b3dd5e434131e3bb4b0c1d7dff3bfd4035672a5086deec6f73979a49be73.js" async="async" data-turbo-track="reload"></script>
<script type="module">import "application"</script>

    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  </head>
  <body>
    <nav class=" text-base z-[50] top-0 absolute w-full lg:h-[5.5rem] lg:px-[5.6rem] py-3 lg:flex lg:justify-between lg:items-center bg-white sticky" id="navbar">
  <a href="/2.1" class="block shrink-0 w-fit mx-auto lg:mx-0">
    <img class="w-40 lg:my-0" src="/assets/logo_blue_ruby-e87334a67ff20033fae8c8d2c07e549b5f1faa9b75bb07fbb2ff9d1c0dfef6e7.svg" />
  </a>
  <div class="lg:hidden absolute right-4 top-2 flex w-9 h-9 items-center" id="hamburgerIcon">
    <div class="pointer-events-none w-full h-0.5 bg-blue transition-all duration-150
                  before:content-[''] before:absolute before:w-full before:h-0.5 before:bg-blue before:-translate-y-2.5 before:transition-all before:duration-150
                  after:content-[''] after:absolute after:w-full after:h-0.5 after:bg-blue after:translate-y-2.5 after:transition-all after:duration-150"></div>
  </div>
  <div class="lg:hidden flex flex-col text-center hidden" id="navList">
    <div class="lg:absolute flex flex-col mt-15 gap-10 uppercase">
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/docs/trailblazer">Documentation</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="https://dev.to/trailblazer">Blog</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/about.html">About</a>
      
      <!-- <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/pro.html">PRO</a> -->
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="https://trailblazer.zulipchat.com">Chat with us</a>
    </div>
  </div>
  <div class="lg:flex hidden gap-10 items-center">
    <div class="flex gap-7">
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold underline decoration-[5px] underline-offset-[15px] decoration-purple hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/docs/trailblazer">Documentation</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="https://dev.to/trailblazer">Blog</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/about.html">About</a>
      <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.0/">→ 2.0</a>
      
      <!-- <a class="font-medium text-base uppercase lg:normal-case lg:font-semibold  hover:underline hover:decoration-[5px] hover:underline-offset-[15px] hover:decoration-purple " href="/2.1/pro.html">PRO</a> -->
    </div>

    <a class="base-button text-base w-[12.5rem] h-[3.25rem] bg-light-purple text-blue hover:text-white hover:bg-purple" href="https://trailblazer.zulipchat.com">Chat with us</a>
  </div>
</nav>

<section>
  <div class="lg:hidden bg-bg-blue text-white fixed left-0 top-20 pr-1 py-3 rounded-r" id="sideNavShowButton" style="writing-mode: vertical-rl; text-orientation: upright;">
    Chapters
  </div>
  <div class="lg:flex">
    <nav class="bg-bg-blue w-screen h-screen fixed top-0 z-20 right-[100vw] overflow-y-scroll lg:w-3/12 lg:max-w-[23rem] lg:overflow-y-visible lg:shrink-0 lg:sticky lg:top-[5.5rem]" id="sideNav">
      <button class="lg:hidden absolute right-4 top-4 text-3xl text-white" id="sideNavHideButton">
        X
      </button>
      <div class="lg:pt-10 lg:pl-5 xl:pl-20 p-10 pl-20 text-white leading-10 space-y-1 h-full overflow-auto">
  


  
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/trailblazer/index.html">Trailblazer</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/operation/index.html">Operation</a>

        

          

            
              <a href="/2.1/docs/activity/deprecated/index.html" class="" title="Deprecated activity docs: :input/:output, ...">
                
                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" class="fill-grey pl-3 hover:fill-purple flex-inline"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M251.7 127.6l0 0c10.5 10.5 24.7 16.4 39.6 16.4H448c8.8 0 16 7.2 16 16v32H48V96c0-8.8 7.2-16 16-16H197.5c4.2 0 8.3 1.7 11.3 4.7l33.9-33.9L208.8 84.7l42.9 42.9zM48 240H464V416c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V240zM285.7 93.7L242.7 50.7c-12-12-28.3-18.7-45.3-18.7H64C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H291.3c-2.1 0-4.2-.8-5.7-2.3z"/></svg>
                 
              </a>

            


          

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/rails_integration/index.html">Rails integration</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/test/index.html">Test</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col border-t-[1px] border-t-light-purple">
      <div class="bg-dark-purple flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/macro/index.html">Macro</a>

        
      </div>


      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-macro-overview">
          <a href="#macro-overview" class="pl-8">Overview</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-macro-nested">
          <a href="#macro-nested" class="pl-8">Nested</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-macro-wrap">
          <a href="#macro-wrap" class="pl-8">Wrap</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-macro-each">
          <a href="#macro-each" class="pl-8">Each</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-macro-model">
          <a href="#macro-model" class="pl-8">Model</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-macro-rescue">
          <a href="#macro-rescue" class="pl-8">Rescue</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-macro-policy">
          <a href="#macro-policy" class="pl-8">Policy</a>
        </div>
      
        
        <!-- FIXME: link should know its IDs. -->
        <div class="flex items-center" id="left-toc-macro-contract">
          <a href="#macro-contract" class="pl-8">Contract</a>
        </div>
      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/workflow/index.html">Workflow</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/endpoint/index.html">Endpoint</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/internals/index.html">Internals</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col border-t-[1px] border-t-light-purple">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/reform/index.html">Reform</a>

        

          

            

              <a href="/2.1/docs/reform/3.0/index.html" class="">
                <span class="h-5 text-[8pt] py-[3px] px-2 rounded-[8px] ml-3 hover:bg-purple hover:border-purple hover:text-white border border-grey text-grey">
                  3.0
                </span>
              </a>
            


          

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/cells/index.html">Cells</a>

        

          

            

              <a href="/2.1/docs/cells/5.0/index.html" class="">
                <span class="h-5 text-[8pt] py-[3px] px-2 rounded-[8px] ml-3 hover:bg-purple hover:border-purple hover:text-white border border-grey text-grey">
                  5.0
                </span>
              </a>
            


          

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/representable/index.html">Representable</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/disposable/index.html">Disposable</a>

        
      </div>


      
    </div>

    
  
    <div class="flex flex-col ">
      <div class=" flex items-center">
        <a class="pl-4 font-bold" href="/2.1/docs/roar/index.html">Roar</a>

        
      </div>


      
    </div>

    
  
</div>


    </nav>
    <div class="lg:p-10 pl-8 pr-4 py-10 bg-light-grey grow">
      <h1 class="lg:text-3xl text-2xl text-blue font-bold">
        <span class="font-black uppercase">
          <span class="py-1 px-3 border border rounded border border-white text-white bg-purple">2.1</span>
          Macro
        </span>
        Documentation
      </h1>

      <div class="xl:flex xl:gap-0.5 mt-5">
        <div class="max-w-3xl lg:p-8 lg:pb-14 p-4 bg-white text-bg-blue space-y-9" id="documentation">
          <h2 id="macro-overview" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center">Overview<span class="flex max-w-fit max-h-7 border border-grey uppercase text-grey text-xs pt-1 pb-1 pl-2 pr-2 pr-1 ml-4 rounded">
            <svg class="fill-grey mt-[2px]" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M168.5 72L256 165l87.5-93h-175zM383.9 99.1L311.5 176h129L383.9 99.1zm50 124.9H256 78.1L256 420.3 433.9 224zM71.5 176h129L128.1 99.1 71.5 176zm434.3 40.1l-232 256c-4.5 5-11 7.9-17.8 7.9s-13.2-2.9-17.8-7.9l-232-256c-7.7-8.5-8.3-21.2-1.5-30.4l112-152c4.5-6.1 11.7-9.8 19.3-9.8H376c7.6 0 14.8 3.6 19.3 9.8l112 152c6.8 9.2 6.1 21.9-1.5 30.4z" /></svg>
            <a href="" class="ml-1" title="This feature was introduced in trailblazer-macro v2.1.11.">trailblazer-macro 2.1.11</a>
          </span></h2>

<p class="">Macros provide shorthand methods to create and configure a particular step in your operation. Trailblazer ships with a handful of macros. Those are implemented in trailblazer-macro and trailblazer-macro-contract.</p>

<p class="">Writing you own macros is a very simple thing to do if you follow the macro API.</p>

<h3 id="macro-overview-general-notes" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">General notes</h3>

<h4 id="macro-overview-general-notes-variable-mapping" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">General notes
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Variable mapping</span>

                  </h4>

<p class="">Most macros internally use <a href="/2.1/docs/activity.html#activity-variable-mapping" class="underline text-purple">variable mapping</a> to allow injection of configuration variables or to limit their own scope. Macros do so by leveraging the composable API using <code class="text-purple">In()</code>, <code class="text-purple">Inject()</code> and <code class="text-purple">Out()</code>.</p>

<p class="">This allows you to <em>add your own</em> variable mapping to a macro, as illustrated in the example below.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Create &lt; Trailblazer::Operation
    step Model(Song, :find_by),
      In() =&gt; -&gt;(ctx, my_id:, **) { ctx.merge(params: {id: my_id}) } # Model() needs {params[:id]}.
    # ...
  end
end
</code></pre>

<p class="">When running the above operation, the exemplary <code class="text-purple">Model()</code> macro will pick the ID from <code class="text-purple">:my_id</code>.</p>

<pre class=""><code class="rounded">result = Create.(my_id: 1)
</code></pre>

<p class="">Please note that you shall <strong>not use <code class="text-purple">:input</code></strong> to configure your macro as it will override internal filters and breaks the macro’s configuration. Go with the new <a href="/2.1/docs/activity.html#activity-variable-mapping-composable-i-o" class="underline text-purple">composable variable mapping</a> which is available from <code class="text-purple">trailblazer</code> 2.1.1 and onwards.</p>

<h2 id="macro-nested" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center">Nested</h2>

<p class="">Only use the <code class="text-purple">Nested()</code> macro if you’re planning to nest an activity that can only be chosen at runtime.</p>

<ul class="space-y-2">
  <li class="list-image-disc ml-10">If you know the nested activity upfront, use <a href="" class="underline text-purple">Subprocess()</a>.</li>
  <li class="list-image-disc ml-10">If you know the activities upfront, and need only need to choose at run-time, use the <a href="#macro-nested-auto_wire" class="underline text-purple"><code class="text-purple">:auto_wire</code> option</a>.</li>
</ul>

<h3 id="macro-nested-dynamic" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Dynamic</h3>

<p class="">Use <code class="text-purple">Nested()</code> to dynamically decide which nested activity to invoke, but when you don’t know all activities to pick from. This is sometimes the case in polymorphic setups, when a part of an operation needs to be “decided” at runtime, with no way to know what this will look like when writing the operation class.</p>

<p class="">Consider the following activity to create a song. Depending on the input in <code class="text-purple">params</code>, you either want to run a nested <code class="text-purple">Id3Tag</code> processor activity for an MP3 song, or <code class="text-purple">VorbisComment</code> at a specific point during the song creation.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(:decide_file_type) # Run either {Id3Tag} or {VorbisComment}
    step :save
    # ...
    def decide_file_type(ctx, params:, **)
      params[:type] == "mp3" ? Id3Tag : VorbisComment
    end
  end
end
</code></pre>

<p class="">When using <code class="text-purple">Nested()</code> with only one argument, the <em>decider</em>, we call this the “dynamic style”. Since we don’t know the possible nested activities upfront, the macro needs to compile several internals at runtime, which will be slower than its static equivalent.</p>

<h4 id="macro-nested-dynamic-decider" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Dynamic
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Decider</span>

                  </h4>

<p class="">The decider can be any “option style” callable: an instance method in the hosting <code class="text-purple">Create</code> activity, any lambda or proc, or a callable object or class. In our example, it’s an instance method.</p>

<p class="">The decider receives <code class="text-purple">ctx</code> and keyword arguments just like any other step. It is run directly before the nested activity is run, it’s <strong>return value decides about</strong> which one that will be: <code class="text-purple">Id3Tag</code> or <code class="text-purple">VorbisComment</code>.</p>

<h4 id="macro-nested-dynamic-nested-activity" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Dynamic
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Nested activity</span>

                  </h4>

<p class="">The nested activity (or operation) will, per default, receive the same <code class="text-purple">ctx</code> that a <code class="text-purple">step</code> in place of <code class="text-purple">Nested()</code> would receive.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Id3Tag &lt; Trailblazer::Activity::Railway
    step :parse
    step :encode_id3
    # ...
  end
end
</code></pre>

<h3 id="macro-nested-auto_wire" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Auto_wire</h3>

<p class="">The recommended way of maintaining dynamically nested operations (or activities) is to use <code class="text-purple">Nested()</code> with the <code class="text-purple">:auto_wire</code> option. It works exactly like its <a href="#macro-nested-dynamic" class="underline text-purple">purely dynamic</a> counterpart but requires you to specify all possible nested activities <strong>at compile-time</strong>.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(:decide_file_type,
      auto_wire: [Id3Tag, VorbisComment]) # explicitely define possible nested activities.
    step :save
    # ...

    def decide_file_type(ctx, params:, **)
      params[:type] == "mp3" ? Id3Tag : VorbisComment
    end
  end
end
</code></pre>

<p class="">The <code class="text-purple">:auto_wire</code> option expects an array of nested activities. While this might seem a bit clumsy, this brings several benefits. First of all, execution is much faster since the entire activity graph is created at compile-time. Second, you can use the Debugging API to <a href="#macro-nested-auto_wire-debugging" class="underline text-purple">introspect things</a>.</p>

<p class="">You can use any type of decider step. In this example, it’s a instance method <code class="text-purple">#decide_file_type</code> on the <code class="text-purple">Nested()</code>-hosting class.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/nested-static-create-53e0ce5e582749e042de6a01990c479e818d6617b21805084173ea5b5fca9fd2.png" /></p>

<p class="">Internally, the “auto-wire” <code class="text-purple">Nested()</code> macro simply returns a small activity as illustrated above in gray. It has a <code class="text-purple">decide</code> step to figure out which nested activity to run, then runs the actual nested activity. All well-known termini (success, failure, pass_fast, fail_fast) of the nested activities are automatically connected to the <code class="text-purple">Nested()</code>’s activity’s termini.</p>

<h4 id="macro-nested-auto_wire-output-wiring" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Auto_wire
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Output Wiring</span>

                  </h4>

<p class="">Given we had a nested activity <code class="text-purple">VorbisComment</code> implemented like so.</p>

<pre class=""><code class="rounded">module Song::Activity
  class VorbisComment &lt; Trailblazer::Activity::Railway
    step :prepare_metadata
    step :encode_cover, Output(:failure) =&gt; End(:unsupported_file_format)
    # ...
  end
end
</code></pre>

<p class="">If the <code class="text-purple">#encode_cover</code> step fails, the activity will stop in the <code class="text-purple">End.unsupported_file_format</code> terminus - an end event very specific to the <code class="text-purple">VorbisComment</code> activity.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/nested-static-vorbiscomment-09f9645152659736e82cf3f41bddde6d7e5a81d9d3e3b68bcee02f5d1c86b390.png" /></p>

<p class="">This new terminus has to be wired explicitely in the nesting activity.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(
        :decide_file_type,
        auto_wire: [Id3Tag, VorbisComment]
      ),
      # Output and friends are used *after* Nested().
      # Connect VorbisComment's {unsupported_file_format} to our {failure} track:
      Output(:unsupported_file_format) =&gt; Track(:failure)

    step :save
    # ...
  end
end
</code></pre>

<p class="">Using <code class="text-purple">Output(:unsupported_file_type)</code> from the Wiring API you can connect this specific terminus to wherever you need it, here it’s routed to the failure track in <code class="text-purple">Create</code>. Note that Wiring API options are used after <code class="text-purple">Nested(...)</code>, not within its parenthesis.</p>

<p class="">The complete activity graph would look a bit like the following diagram.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/nested-static-complete-b25ee2ee5a0ffc276bb0d855662fed3241c8af6d0261f432841b7e578cf446e5.png" /></p>

<h3 id="macro-nested-compliance" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Compliance</h3>

<h4 id="macro-nested-compliance-debugger" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Compliance
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Debugger</span>

                  </h4>

<p class=""><code class="text-purple">Nested</code> setups are traceable using <code class="text-purple">#wtf?</code>.</p>

<pre class=""><code class="rounded">
Trailblazer::Developer.wtf?(Song::Activity::Create, params: {type: "vorbis"})</code></pre>

<p class="">The above examples result in a flow as follows.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/nested-static-trace-33fe6a9b27408f00c154d2d12e46da3aef68d76d76ebbd2b525e9b199bba5d5d.png" /></p>

<h4 id="macro-nested-compliance-introspect" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Compliance
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Introspect</span>

                  </h4>

<p class="">The trace is fully compatible with the Debugging API and allows compile-time introspection. For example, you can specify the path to a nested activity <code class="text-purple">Id3Tag</code> and inspect it.</p>

<pre class=""><code class="rounded">Trailblazer::Developer.render(Song::Activity::Create,
  path: [
    "Nested/decide_file_type", # ID of Nested()
    Song::Activity::Id3Tag      # ID of the nested {Id3Tag} activity.
  ]
)
</code></pre>

<p class="">Note that the ID of the nested activities are the class constants.</p>

<h4 id="macro-nested-compliance-patch" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Compliance
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Patch</span>

                  </h4>

<h2 id="macro-wrap" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center">Wrap</h2>

<p class="">Sometimes you need to run a sequence of steps within some block you provide. Often, this is required when certain steps must be wrapped in a database transaction. The <code class="text-purple">Wrap()</code> macro does just that.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Upload &lt; Trailblazer::Activity::FastTrack
    step :model
    step Wrap(MyTransaction) {
      step :update   # this changes the database.
      step :transfer # this might even break!
    }
    step :notify
    fail :log_error
    # ...
  end
end
</code></pre>

<p class="">In an imaginary song <code class="text-purple">Upload</code> operation that transfers a music file to some streaming service platform while updating fields on the database, needs the steps <code class="text-purple">#update</code> and <code class="text-purple">#transfer</code> being run inside a transaction. The code running and interpreting this block is provided via the custom transaction <code class="text-purple">MyTransaction</code>.</p>

<h3 id="macro-wrap-wrap-handler" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Wrap handler</h3>

<p class="">The most simple “transaction” (we call it <em>wrap handler</em>) could look as follows.</p>

<pre class=""><code class="rounded">class MyTransaction
  def self.call((ctx, flow_options), **, &amp;block)
    signal, (ctx, flow_options) = yield # calls the wrapped steps

    return signal, [ctx, flow_options]
  end
end
</code></pre>

<p class="">Your transaction handler can be any type of [callable] exposing the <a href="activity.html#activity-internals-circuit-interface" class="underline text-purple">circuit interface</a>.</p>

<p class="">In the most simple transaction ever written, we simply run the wrapped steps by calling <code class="text-purple">yield</code>. This will return a circuit-interface return set. The interesting parts are the returned <code class="text-purple">ctx</code>, which is the ctx that left the wrapped steps, and the <code class="text-purple">signal</code>, which indicates the outcome of running the wrapped steps.</p>

<p class="">Here, we simply return the original signal of the wrapped activity.</p>

<p class="">Note that internally <code class="text-purple">#update</code> and <code class="text-purple">#transfer</code> are put into a separate activity. The terminus reached in that activity is the signal.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/wrap-f19981a15143742a9b363da41091290a565fb3d5e728da9d6822a5b30712c81b.png" /></p>

<p class="">Given that both <code class="text-purple">#update</code> and <code class="text-purple">#transfer</code> are railway steps, the wrapped code can terminate in a <code class="text-purple">success</code> terminus, or a <code class="text-purple">failure</code>.
Now, it’s your handler that is responsible to interpret that. In the example above, we simply pass on the wrapped activity’s terminal signal, making the <code class="text-purple">Upload</code> activity either continue from <code class="text-purple">success</code> or from <code class="text-purple">failure</code>.</p>

<h4 id="macro-wrap-wrap-handler-routing" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Wrap handler
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Routing</span>

                  </h4>

<p class="">Let’s assume the <code class="text-purple">#transfer</code> step had a custom output that goes to a super-special terminus <code class="text-purple">End.timeout</code>.</p>

<pre class=""><code class="rounded">step Wrap(MyTransaction) {
  step :update   # this changes the database.
  step :transfer,
    Output(:failure) =&gt; End(:timeout) # creates a third terminus.
},
</code></pre>

<p class="">The resulting wrapped activity now has three termini.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/wrap-timeout-113e68ad4bdfb447ed448cbdc296c3fdf4a89089e305c3ca433adea46d3c3704.png" /></p>

<p class="">With our handler, which simply returns the wrapped activity’s signal, it’s possible to route the <code class="text-purple">:timeout</code> signal in <code class="text-purple">Upload</code>. For instance, if a <code class="text-purple">:timeout</code> should be resulting in <code class="text-purple">Upload</code> jumping to the <code class="text-purple">fail_fast</code> track after <code class="text-purple">#transfer</code> terminated in <code class="text-purple">timeout</code>, you can do so.</p>

<pre class=""><code class="rounded">step Wrap(MyTransaction) {
  step :update   # this changes the database.
  step :transfer,
    Output(:failure) =&gt; End(:timeout) # creates a third terminus.
},
  Output(:timeout) =&gt; Track(:fail_fast) # any wiring is possible here.
</code></pre>

<p class="">Here’s what the circuit would look like.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/wrap-route-ec3d6c04738282e4b99de87d494e4f738d97771b4148aa89c9a7e7f80db24871.png" /></p>

<h3 id="macro-wrap-transaction" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Transaction</h3>

<p class="">Wrapping steps into a real database transaction, and rolling back in case of a failure outcome in one of the steps, could look like so.</p>

<pre class=""><code class="rounded">class MyTransaction
  def self.call((ctx, flow_options), **)
    handler_signal = nil # this is the signal we decide to return from Wrap().

    ActiveRecord::Base.transaction do
      signal, (ctx, flow_options) = yield # call the Wrap block

      # It's now up to us to interpret the wrapped activity's outcome.
      terminus_semantic = signal.to_h[:semantic]

      if [:success, :pass_fast].include?(terminus_semantic)
        handler_signal = Trailblazer::Activity::Right
      else # something in the wrapped steps went wrong:
        handler_signal = Trailblazer::Activity::Left

        raise ActiveRecord::Rollback # This is the only way to tell ActiveRecord to rollback!
      end
    end # transaction

    return handler_signal, [ctx, flow_options]
  end
end
</code></pre>

<p class="">This might look a bit clumsy, but most of the code is very straight-forward.</p>

<ol>
  <li class="list-image-disc ml-10">Your main intent, wrapping a sequence of steps into an <code class="text-purple">ActiveRecord::Base.transaction</code> block, contains the <code class="text-purple">yield</code> invocation that runs the wrapped steps.</li>
  <li class="list-image-disc ml-10">Having the <code class="text-purple">signal</code> of the wrapped activity returned, you can decide how you’d like to interpret that. Usually, looking at the signals <code class="text-purple">:semantic</code> field indicates the outcome.</li>
  <li class="list-image-disc ml-10">In case you’re not happy, a <code class="text-purple">raise ActiveRecord::Rollback</code> will make ActiveRecord undo whatever database commits happened in the block.</li>
  <li class="list-image-disc ml-10">Instead of returning the nested activity’s <code class="text-purple">signal</code>, which is completely legit, <code class="text-purple">Wrap()</code> also allows you to return a <code class="text-purple">Right</code> or <code class="text-purple">Left</code> signal to communicate the outcome of the entire <code class="text-purple">Wrap()</code> component.</li>
</ol>

<h3 id="macro-wrap-exception-handling" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Exception handling</h3>

<p class="">Catching and intercepting exceptions in <code class="text-purple">Wrap()</code> works identical to transactions. In case you don’t want to use our canonical <a href="#---FIXME" class="underline text-purple">Rescue() macro</a> here is a sample wrap handler that uses <code class="text-purple">rescue</code> for intercepting exceptions thrown in <code class="text-purple">#update</code> or <code class="text-purple">#transfer</code>.</p>

<pre class=""><code class="rounded">class MyRescue
  def self.call((ctx, flow_options), **, &amp;block)
    signal, (ctx, flow_options) = yield # calls the wrapped steps

    return signal, [ctx, flow_options]
  rescue
    ctx[:exception] = $!.message
    return Trailblazer::Activity::Left, [ctx, flow_options]
  end
end
</code></pre>

<p class="">With any exception being thrown, the original signal from the wrapped activity is returned, as if the steps were part of the <code class="text-purple">Upload</code> operation flow.</p>

<p class="">The code below <code class="text-purple">rescue</code> is only run when an exception was thrown. Here, we write a new variable <code class="text-purple">:exception </code> to the <code class="text-purple">ctx</code> and return <code class="text-purple">Left</code>, indicating an error.</p>

<h3 id="macro-wrap-compliance" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Compliance</h3>

<h4 id="macro-wrap-compliance-debugger" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Compliance
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Debugger</span>

                  </h4>

<p class="">You can use tracing with <code class="text-purple">Wrap()</code>.</p>

<pre class=""><code class="rounded">
Trailblazer::Developer.wtf?(Song::Activity::Upload, params: {id: 1})</code></pre>

<p class="">The trace per default shows Wrap’s ID.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/wrap-trace-aa2f28f630a403fb26227db61373bc2aef89982116ed00e1f86904ddcf99f8f9.png" /></p>

<h4 id="macro-wrap-compliance-introspect" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Compliance
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Introspect</span>

                  </h4>

<p class="">You can use any <code class="text-purple">Introspect</code> mechanics on activities using <code class="text-purple">Wrap()</code>.</p>

<pre class=""><code class="rounded">node, _ = Trailblazer::Developer::Introspect.find_path(
  Song::Activity::Upload,
  ["Wrap/MyTransaction", :transfer])
#=&gt; #&lt;Node ...&gt;
</code></pre>

<h4 id="macro-wrap-compliance-patch" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Compliance
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Patch</span>

                  </h4>

<p class=""><code class="text-purple">Wrap()</code> is compatible with the Patch API, as in, you may replace nested steps or entire activities within the wrapped part.</p>

<p class="">Consider the <code class="text-purple">Upload</code> activity used throughout this example.</p>
<pre class=""><code class="rounded">module Song::Activity
  class Upload &lt; Trailblazer::Activity::FastTrack
    step :model
    step Wrap(MyTransaction) {
      step :update   # this changes the database.
      step :transfer # this might even break!
    }
    step :notify
    fail :log_error
    # ...
  end
end
</code></pre>

<p class="">Say you want to replace the <code class="text-purple">#update</code> step within the wrap with a new step <code class="text-purple">#upsert</code>, you can use <code class="text-purple">Patch</code> as so.</p>

<pre class=""><code class="rounded">upload_with_upsert = Trailblazer::Activity::DSL::Linear::Patch.call(
  Song::Activity::Upload,
  ["Wrap/MyTransaction"],
  -&gt; { step :upsert, replace: :update }
)
</code></pre>

<p class="">The returned new activity <code class="text-purple">upload_with_upsert</code> is a copy of <code class="text-purple">Upload</code> with the respective step replace. Note that in this very example, the method <code class="text-purple">#upsert</code> has to be included in the nested activity.</p>

<h2 id="macro-each" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center">Each<span class="flex max-w-fit max-h-7 border border-grey uppercase text-grey text-xs pt-1 pb-1 pl-2 pr-2 pr-1 ml-4 rounded">
            <svg class="fill-grey mt-[2px]" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M168.5 72L256 165l87.5-93h-175zM383.9 99.1L311.5 176h129L383.9 99.1zm50 124.9H256 78.1L256 420.3 433.9 224zM71.5 176h129L128.1 99.1 71.5 176zm434.3 40.1l-232 256c-4.5 5-11 7.9-17.8 7.9s-13.2-2.9-17.8-7.9l-232-256c-7.7-8.5-8.3-21.2-1.5-30.4l112-152c4.5-6.1 11.7-9.8 19.3-9.8H376c7.6 0 14.8 3.6 19.3 9.8l112 152c6.8 9.2 6.1 21.9-1.5 30.4z" /></svg>
            <a href="" class="ml-1" title="This feature was introduced in trailblazer-macro v2.1.12.">trailblazer-macro 2.1.12</a>
          </span></h2>

<p class="">The <code class="text-purple">Each()</code> macro allows to loop over a dataset while invoking a particular operation per iteration, as if multiple identical operations were serially connected, but receiving different input ctxs.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Cover &lt; Trailblazer::Activity::Railway
    step :model
    step Each(dataset_from: :composers_for_each) {
      step :notify_composers
    }
    step :rearrange

    # "decider interface"
    def composers_for_each(ctx, model:, **)
      model.composers
    end

    def notify_composers(ctx, index:, item:, **)
      Mailer.send(to: item.email, message: "#{index}) You, #{item.full_name}, have been warned about your song being copied.")
    end
    def model(ctx, params:, **)
      ctx[:model] = Song.find_by(id: params[:id])
    end

    include T.def_steps(:rearrange)
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Cover &lt; Trailblazer::Operation
    step :model
    step Each(dataset_from: :composers_for_each) {
      step :notify_composers
    }
    step :rearrange

    # "decider interface"
    def composers_for_each(ctx, model:, **)
      model.composers
    end

    def notify_composers(ctx, index:, item:, **)
      Mailer.send(to: item.email, message: "#{index}) You, #{item.full_name}, have been warned about your song being copied.")
    end
    def model(ctx, params:, **)
      ctx[:model] = Song.find_by(id: params[:id])
    end

    include T.def_steps(:rearrange)
  end
end
</code></pre></div></div>

<p class="">You can either pass a block with steps to iterate, or an entire operation/activity. In this example, a block is used. Note that you need to use the <code class="text-purple">{}</code> curly braces due to Ruby’s precedence, just as it’s done in <code class="text-purple">Wrap()</code>.</p>

<h3 id="macro-each-dataset_from" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">dataset_from</h3>

<p class="">While you could simply assign a ctx variable <code class="text-purple">:dataset</code> in a step preceding the <code class="text-purple">Each()</code> macro, the recommended way is using <code class="text-purple">:dataset_from</code> and implementing a dedicated dataset provider.</p>

<pre class=""><code class="rounded">step Each(dataset_from: :composers_for_each) {
  step :notify_composers
}
</code></pre>

<p class="">This can be an instance method or any kind of callable, following the “decider interface”.</p>

<pre class=""><code class="rounded">def composers_for_each(ctx, model:, **)
  model.composers
end
</code></pre>

<p class="">Note that our dataset provider is an instance method <code class="text-purple">#composers_for_each</code> defined on the operation class hosting <code class="text-purple">Each()</code>. It exposes a step signature with ctx and handy keyword arguments and simply returns the dataset. It explicitely does not write to <code class="text-purple">ctx</code>!</p>

<p class="">The only requirement to the dataset provider’s return value is that it returns an enumerable object - usually, that’s an array.</p>

<h3 id="macro-each-iterated-block" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Iterated Block</h3>

<p class="">Note that the iterated block’s <code class="text-purple">:instance_method</code>s are defined in the <code class="text-purple">Each()</code>-hosting activity, too.</p>

<pre class=""><code class="rounded">def notify_composers(ctx, index:, item:, **)
  Mailer.send(to: item.email, message: "#{index}) You, #{item.full_name}, have been warned about your song being copied.")
end
</code></pre>

<p class="">Per default, <code class="text-purple">Each()</code> will loop over the dataset using <code class="text-purple">#each</code> and pass the iterated item and its index into each step of the block, named <code class="text-purple">:item</code> and <code class="text-purple">:index</code>.</p>

<h4 id="macro-each-iterated-block-item-key" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Iterated Block
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">item key</span>

                  </h4>

<p class="">If you don’t like the <code class="text-purple">:item</code> keyword argument in your steps, you can configure it using the <code class="text-purple">:item_key</code> option for <code class="text-purple">Each()</code>.</p>

<pre class=""><code class="rounded">step Each(dataset_from: :composers_for_each, item_key: :composer) {
  step :notify_composers
}
</code></pre>

<p class="">The iterated steps now receive a <code class="text-purple">:composer</code> ctx variable instead of <code class="text-purple">:item</code>.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Cover &lt; Trailblazer::Activity::Railway
    # ...
    def notify_composers(ctx, index:, composer:, **)
      Mailer.send(to: composer.email, message: "#{index}) You, #{composer.full_name}, have been warned about your song being copied.")
    end
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Cover &lt; Trailblazer::Operation
    # ...
    def notify_composers(ctx, index:, composer:, **)
      Mailer.send(to: composer.email, message: "#{index}) You, #{composer.full_name}, have been warned about your song being copied.")
    end
  end
end
</code></pre></div></div>

<h4 id="macro-each-iterated-block-operation" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Iterated Block
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">operation</span>

                  </h4>

<p class="">If you would like the iterated steps to be within the “block”, use a dedicted activity or operation.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Cover &lt; Trailblazer::Activity::Railway
    step :model
    step Each(Notify, dataset_from: :composers_for_each)
    step :rearrange
    # ...
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Cover &lt; Trailblazer::Operation
    step :model
    step Each(Notify, dataset_from: :composers_for_each)
    step :rearrange
    # ...
  end
end
</code></pre></div></div>

<p class="">The iterated operation is composed of steps that have an identical interface with the block version.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Notify &lt; Trailblazer::Activity::Railway
    step :send_email

    def send_email(ctx, index:, item:, **)
      Mailer.send(to: item.email, message: "#{index}) You, #{item.full_name}, have been warned about your song being copied.")
    end
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Notify &lt; Trailblazer::Operation
    step :send_email

    def send_email(ctx, index:, item:, **)
      Mailer.send(to: item.email, message: "#{index}) You, #{item.full_name}, have been warned about your song being copied.")
    end
  end
end
</code></pre></div></div>

<h3 id="macro-each-collect-option" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Collect option</h3>

<p class="">Ctx variables set within an iteration <a href="#macro-each-variable-mapping" class="underline text-purple">are discarded per default</a>. While you could configure <a href="#macro-each-variable-mapping-filtering" class="underline text-purple">collecting values yourself</a>, you can use the <code class="text-purple">:collect</code> option.</p>

<pre class=""><code class="rounded">step Each(dataset_from: :composers_for_each, collect: true) {
  step :notify_composers
}
</code></pre>

<p class="">If one of your iterated steps sets <code class="text-purple">ctx[:value]</code> within <code class="text-purple">Each()</code>, this value will be collected.</p>

<pre class=""><code class="rounded">def notify_composers(ctx, index:, item:, **)
  ctx[:value] = [index, item.full_name]
end
</code></pre>

<p class="">All collected values are available at <code class="text-purple">ctx[:collected_from_each]</code> when <code class="text-purple">Each()</code> is finished.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">ctx = {params: {id: 1}} # Song 1 has two composers.

signal, (ctx, _) = Trailblazer::Activity.(Song::Activity::Cover, ctx)

puts ctx[:collected_from_each] #=&gt; [[0, "Fat Mike"], [1, "El Hefe"]]
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">ctx = {params: {id: 1}} # Song 1 has two composers.

result = Song::Operation::Cover.(ctx)

puts result[:collected_from_each] #=&gt; [[0, "Fat Mike"], [1, "El Hefe"]]
</code></pre></div></div>

<h3 id="macro-each-variable-mapping" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Variable mapping</h3>

<p class="">The <code class="text-purple">Each()</code> macro allows to configure what goes in and out of each iteration. However, it provides a default setting.</p>

<pre class=""><code class="rounded">step Each(dataset_from: :composers_for_each) {
  step :notify_composers
  step :write_to_ctx
}
</code></pre>

<ul class="space-y-2">
  <li class="list-image-disc ml-10">Per default, the iterated steps can see the entire outer <code class="text-purple">ctx</code>, plus <code class="text-purple">:index</code> and <code class="text-purple">:item</code>.</li>
  <li class="list-image-disc ml-10">Any variable written to <code class="text-purple">ctx</code> is discarded after the iteration.</li>
</ul>

<pre class=""><code class="rounded">def write_to_ctx(ctx, index:, seq:, **)
  # ...
  ctx[:variable] = index # this is discarded!
end
</code></pre>

<p class="">This default setting assures that no data from the iteration bleeds into the outer ctx.</p>

<h4 id="macro-each-variable-mapping-filtering" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Variable mapping
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Filtering</span>

                  </h4>

<p class="">You may configure what goes in and out of the iterated activity. Use the variable mapping API by passing arguments to <code class="text-purple">Each()</code>.</p>

<p class="">For example, say you want to collect messages from each iteration.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Cover &lt; Trailblazer::Activity::Railway
    step :model
    step Each(dataset_from: :composers_for_each,
      Inject(:messages) =&gt; -&gt;(*) { {} },

      # all filters called before/after each iteration!
      Out() =&gt; [:messages]
    ) {
      step :write_to_ctx
    }
    step :rearrange

    def write_to_ctx(ctx, item:, messages:, index:, **)
      ctx[:messages] = messages.merge(index =&gt; item.full_name)
    end
    include EachTest::CoverMethods
    include EachTest::ComposersForEach
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Cover &lt; Trailblazer::Operation
    step :model
    step Each(dataset_from: :composers_for_each,
      Inject(:messages) =&gt; -&gt;(*) { {} },

      # all filters called before/after each iteration!
      Out() =&gt; [:messages]
    ) {
      step :write_to_ctx
    }
    step :rearrange

    def write_to_ctx(ctx, item:, messages:, index:, **)
      ctx[:messages] = messages.merge(index =&gt; item.full_name)
    end
    include EachTest::CoverMethods
    include EachTest::ComposersForEach
  end
end
</code></pre></div></div>

<ol>
  <li class="list-image-disc ml-10">When starting the iteration, the ctx variable <code class="text-purple">:messages</code> will be initialized to an empty hash (unless you provide it in the outside ctx).</li>
  <li class="list-image-disc ml-10">The <code class="text-purple">#write_to_ctx</code> step within <code class="text-purple">Each()</code> sees that <code class="text-purple">:messages</code> variable and can override it, adding its non-sense message to the hash.</li>
  <li class="list-image-disc ml-10">Since you configured <code class="text-purple">Out() =&gt; [:messages]</code>, the following iteration will see that very <code class="text-purple">:messages</code> variable from the last iteration.</li>
</ol>

<p class="">This allows to collect outgoing variables from the iterations, even in case of failures.</p>

<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">Note how the <code class="text-purple">Inject()</code> and <code class="text-purple">Out()</code> calls are within the parenthesis of <code class="text-purple">Each()</code>.</p>

  </div>
</div>

<h3 id="macro-each-failure" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Failure</h3>

<p class="">If not configured, a failing iterated step leads the entire iteration to be stopped. The <code class="text-purple">Each()</code> activity will terminate on its <code class="text-purple">failure</code> terminus.</p>

<p class="">You can still access <code class="text-purple">ctx[:collected_from_each]</code> for each iterated block. Note that you can even see which iteration failed in the trace!</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/each-failure-trace-8bffd33d6ef1cd14eb8d18d2ed59c8ba469d817ff1549ac76257ee0205c87062.png" /></p>

<p class="">In combination with TRB’s debugger, this gives you a powerful tool for finding bugs in your code or understanding the flow, without having to jump around through iterations using <code class="text-purple">pry</code> or other tools.</p>

<h3 id="macro-each-compliance" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Compliance</h3>

<h4 id="macro-each-compliance-debugger" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Compliance
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Debugger</span>

                  </h4>

<p class="">You can use tracing with <code class="text-purple">Each()</code>.</p>

<pre class=""><code class="rounded">Trailblazer::Developer.wtf?(Song::Activity::Cover, [{
  params: {id: 1},
  # ...
}])
</code></pre>

<p class="">Note that a virtual step <code class="text-purple">invoke_block_activity</code> is displayed to group the iterations, suffixed with the number of the iteration.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/each-trace-ea938758bbe294226d67b7ce635d2f6b2a572f99815306cf2ef14a78d19fbbb2.png" /></p>

<p class="">TODO: show how runtime data can be accessed for each iterated block.</p>

<h4 id="macro-each-compliance-introspect" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Compliance
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Introspect</span>

                  </h4>

<p class="">You can use any <code class="text-purple">Introspect</code> mechanics on the nested activity using <code class="text-purple">Each()</code>.</p>

<pre class=""><code class="rounded">node, _ = Trailblazer::Developer::Introspect.find_path(
  Song::Activity::Cover,
  ["Each/composers_for_each", "Each.iterate.block", "invoke_block_activity", :notify_composers])
#=&gt; #&lt;Node ...&gt;
</code></pre>

<h4 id="macro-each-compliance-patch" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Compliance
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Patch</span>

                  </h4>

<p class="">You may patch the iterated activity.</p>

<pre class=""><code class="rounded">cover_patched = Trailblazer::Activity::DSL::Linear::Patch.(
  Song::Activity::Cover,
  ["Each/composers_for_each", "Each.iterate.block"],
  -&gt; { step :log_email }
)
</code></pre>

<p class="">Here, the <code class="text-purple">Each.iterate.block</code> task represents the nested iterated activity.</p>

<h2 id="macro-model" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center">Model</h2>

<p class="">An operation can automatically find or create a model for you using the <code class="text-purple">Model()</code> macro. The produced model is written to <code class="text-purple">ctx[:model]</code>.</p>

<p class="">You could easily write this code yourself, nevertheless, our macro comes with a bunch of helpful features.</p>

<h3 id="macro-model-model-find" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Model::Find</h3>

<p class=""><a href="https://github.com/trailblazer/trailblazer-macro" class="pink"><i class="fa fa-gem" aria-hidden="true"></i> trailblazer-macro 2.1.16</a></p>

<p class="">In operations that target existing models, the <code class="text-purple">Model::Find()</code> macro is the right tool to use.</p>

<h4 id="macro-model-model-find-find_by" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model::Find
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Find_by</span>

                  </h4>

<p class="">To find a model by its ID using <code class="text-purple">Song.find_by(id: id)</code> use the macro like so.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Update &lt; Trailblazer::Activity::Railway
    step Model::Find(Song, find_by: :id)
    step :validate
    step :save
    # ...
  end
end
</code></pre>

<p class="">The <code class="text-purple">id</code> value is extracted from <code class="text-purple">id = params[:id]</code>.</p>

<p class="">Note that the finder method doesn’t have to be <code class="text-purple">find_by</code> - you may pass any method name to <code class="text-purple">Find()</code>, for example <code class="text-purple">:where</code>.</p>

<p class="">The <code class="text-purple">id:</code> key is also up to you. As an example, you can dictate a query with a different key using the following code.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Update &lt; Trailblazer::Activity::Railway
    step Model::Find(Song, find_by: :short_id) # Song.find_by(short_id: params[:short_id])
    step :validate
    step :save
    # ...
  end
end
</code></pre>

<h4 id="macro-model-model-find-params_key" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model::Find
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">params_key</span>

                  </h4>

<p class="">Sometimes the ID key and the <code class="text-purple">params</code> key differ. Use the <code class="text-purple">:params_key</code> option if you want to look into <code class="text-purple">params</code> using a different key.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Update &lt; Trailblazer::Activity::Railway
    step Model::Find(Song, find_by: :id, params_key: :slug) # Song.find_by(id: params[:slug])
    step :validate
    step :save
    # ...
  end
end
</code></pre>

<h4 id="macro-model-model-find-id_from" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model::Find
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">id_from</span>

                  </h4>

<p class="">If the ID extraction is more complicated, maybe you need to look into a deeply nested hash in <code class="text-purple">params</code>, use the block style to implement your own extraction.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Update &lt; Trailblazer::Activity::Railway
    step Model::Find(Song, find_by: :id) { |ctx, params:, **|
      params[:song] &amp;&amp; params[:song][:id]
    }
    step :validate
    step :save
    # ...
  end
end
</code></pre>

<p class="">The block receives the same <code class="text-purple">ctx, **kws</code> style arguments that an ordinary step would.</p>

<h4 id="macro-model-model-find-not-found" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model::Find
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Not Found</span>

                  </h4>

<p class="">You can wire the <code class="text-purple">Model::Find()</code> step to a dedicated terminus <code class="text-purple">:not_found</code> in case of a missing model (instead of connecting it to the default failure track). The new terminus represents an explicit outcome and could, for instance, be used in an <a href="/2.1/docs/endpoint.html" class="underline text-purple">endpoint</a> to render a <strong>404 response</strong> without having to check if <code class="text-purple">ctx[:model]</code> is present or not.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/model-not-found-df43034c45d6953bca466a01d533ec2b24197bcff7aa02f2cae60a8c02357089.png" /></p>

<p class="">To add the explicit <code class="text-purple">End.not_found</code>terminus, pass the <code class="text-purple">:not_found_terminus</code> option to the macro.</p>

<pre class=""><code class="rounded">class Song
  module Activity
    class Update &lt; Trailblazer::Activity::Railway
      step Model::Find(Song, find_by: :id, not_found_terminus: true)
      step :validate
      step :save
      include T.def_steps(:validate, :save)
    end
  end
end
</code></pre>

<p class="">When running the <code class="text-purple">Update</code> activity with an invalid ID, it terminates on <code class="text-purple">End.not_found</code>.</p>

<pre class=""><code class="rounded">signal, (ctx, _) = Trailblazer::Activity::TaskWrap.invoke(Song::Activity::Update, [{params: {id: nil}},{}])
puts signal #=&gt; #&lt;Trailblazer::Activity::End semantic=:not_found&gt;
</code></pre>

<h4 id="macro-model-model-find-find" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model::Find
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">find</span>

                  </h4>

<p class="">In case your model needs to be retrieved using a positional ID argument, use the <code class="text-purple">:find</code> style without a hash.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Update &lt; Trailblazer::Activity::Railway
    step Model::Find(Song, :find) # Song.find(id)
    step :validate
    step :save
    # ...
  end
end
</code></pre>

<p class="">This will result in an invocation like <code class="text-purple">Song.find(id)</code>. As always <code class="text-purple">:find</code> can be anything, for example, <code class="text-purple">:[]</code> in case you’re using Sequel.</p>

<h4 id="macro-model-model-find-debugging" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model::Find
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Debugging</span>

                  </h4>

<p class="">With tracing turned on, you can see that <code class="text-purple">Model::Find()</code> actually creates a tiny activity with two steps.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/model_find_trace-bc4680889f4e540df99279d9766160dafe7b90e19fa09b254e5abdf125e43d8c.png" /></p>

<ol>
  <li class="list-image-disc ml-10">The first extracts the ID from params. If this step fails, your configured ID couldn’t be found</li>
  <li class="list-image-disc ml-10">The second step runs the finder.</li>
</ol>

<h3 id="macro-model-model-build" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Model::Build</h3>

<p class="">For <code class="text-purple">Create</code> operations without an existing model you can use <code class="text-purple">Model::Build</code> to instantiate a new model.</p>

<pre class=""><code class="rounded">module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step Model::Build(Song, :new)
    step :validate
    step :save
    # ...
  end
end
</code></pre>

<p class="">Here, <code class="text-purple">:new</code> might be replace with any method you want to be called on <code class="text-purple">Song</code>, e.g. <code class="text-purple">:build</code>.</p>

<h3 id="macro-model-dependency-injection" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Dependency Injection</h3>

<h3 id="macro-model-model" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Model</h3>

<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">The <code class="text-purple">Model()</code> macro will be deprecated and removed in Trailblazer 2.2. Please switch over to the more powerful <a href="/2.1/docs/macro.html#macro-model-model-find" class="underline text-purple"><code class="text-purple">Model::Find</code> and friends</a>.</p>

  </div>
</div>

<p class="">An operation can automatically find or create a model for you using the <code class="text-purple">Model()</code> macro.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step Model(Song, :new)
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Create &lt; Trailblazer::Operation
    step Model(Song, :new)
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div></div>

<p class="">After this step, there is a fresh model instance under <code class="text-purple">ctx[:model]</code> that can be used in all following steps and the returned result object.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">signal, (ctx, _) = Trailblazer::Activity.(Song::Activity::Create, params: {})
puts ctx[:model] #=&gt; #&lt;struct Song id=nil, title=nil&gt;
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">result = Song::Operation::Create.(params: {})
puts result[:model] #=&gt; #&lt;struct Song id=nil, title=nil&gt;
</code></pre></div></div>

<p class="">Internally, the <code class="text-purple">Model()</code> macro will simply invoke <code class="text-purple">Song.new</code> to populate <code class="text-purple">ctx[:model]</code>.</p>

<h4 id="macro-model-model-find_by" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Find_by</span>

                  </h4>

<p class="">You can also find models using <code class="text-purple">:find_by</code>. This is helpful for <code class="text-purple">Update</code> or <code class="text-purple">Delete</code> operations.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Update &lt; Trailblazer::Activity::Railway
    step Model(Song, :find_by)
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Update &lt; Trailblazer::Operation
    step Model(Song, :find_by)
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div></div>

<p class="">The <code class="text-purple">Model</code> macro will invoke the following code for you.</p>

<pre class=""><code class="rounded">
ctx[:model] = Song.find_by(id: params[:id])</code></pre>

<p class="">This will assign <code class="text-purple">ctx[:model]</code> for you by invoking <code class="text-purple">find_by</code>.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">signal, (ctx, _) = Trailblazer::Activity.(Song::Activity::Update, params: {id: 1}, seq: [])
ctx[:model] #=&gt; #&lt;Song id=1, ...&gt;
puts signal #=&gt; #&lt;Trailblazer::Activity::End semantic=:success&gt;
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">result = Song::Operation::Update.(params: {id: 1}, seq: [])
result[:model] #=&gt; #&lt;Song id=1, ...&gt;
result.success? # =&gt; true
</code></pre></div></div>

<p class="">If <code class="text-purple">Song.find_by</code> returns <code class="text-purple">nil</code>, this will deviate to the failure track, skipping the rest of the operation.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">signal, (ctx, _) = Trailblazer::Activity.(Song::Activity::Update, params: {})
ctx[:model] #=&gt; nil
puts signal #=&gt; #&lt;Trailblazer::Activity::End semantic=:failure&gt;
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">result = Song::Operation::Update.(params: {})
result[:model] #=&gt; nil
result.success? # =&gt; false
</code></pre></div></div>

<h4 id="macro-model-model-key" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Key</span>

                  </h4>

<p class="">It is also possible to <code class="text-purple">find_by</code> using an attribute other than <code class="text-purple">:id</code>.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Update &lt; Trailblazer::Activity::Railway
    step Model(Song, :find_by, :title) # third positional argument.
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Update &lt; Trailblazer::Operation
    step Model(Song, :find_by, :title) # third positional argument.
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div></div>

<h4 id="macro-model-model-find" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">find</span>

                  </h4>

<p class="">Note that, instead of <code class="text-purple">find_by</code>, you may also use <code class="text-purple">:find</code>. This is not recommended, though, since it raises an exception, which is not the preferred way of flow control in Trailblazer.</p>

<h4 id="macro-model-model-arbitrary-finder" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Arbitrary Finder</span>

                  </h4>

<p class="">It’s possible to specify any finder method, which is helpful with ROMs such as Sequel.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Update &lt; Trailblazer::Activity::Railway
    step Model(Song, :[])
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Update &lt; Trailblazer::Operation
    step Model(Song, :[])
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div></div>

<p class="">The provided method will be invoked and Trailblazer passes to it the value of<code class="text-purple">params[:id]</code>.</p>

<pre class=""><code class="rounded">
Song[params[:id]]</code></pre>

<p class="">Given your database gem provides that finder, it will result in a query.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">signal, (ctx, _) = Trailblazer::Activity.(Song::Activity::Update, params: {id: 1}, seq: [])
ctx[:model] #=&gt; #&lt;struct Song id=1, title="Roxanne"&gt;
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">result = Song::Operation::Update.(params: {id: 1}, seq: [])
result[:model] #=&gt; #&lt;struct Song id=1, title="Roxanne"&gt;
</code></pre></div></div>

<h4 id="macro-model-model-not-found" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Not Found</span>

                  </h4>

<p class="">You can wire the <code class="text-purple">Model()</code> step to a dedicated terminus <code class="text-purple">:not_found</code> in case of a missing model, instead of connecting it to the default failure track. The new terminus represents an explicit outcome and could, for instance, be used in an <a href="/2.1/docs/endpoint.html" class="underline text-purple">endpoint</a> to render a <strong>404 response</strong> without having to check if <code class="text-purple">ctx[:model]</code> is present or not.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/model-not-found-df43034c45d6953bca466a01d533ec2b24197bcff7aa02f2cae60a8c02357089.png" /></p>

<p class="">To add the explicit <code class="text-purple">End.not_found</code>terminus, pass the <code class="text-purple">:not_found_terminus</code> option to the macro.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Update &lt; Trailblazer::Activity::Railway
    step Model(Song, :find_by, not_found_terminus: true)
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Update &lt; Trailblazer::Operation
    step Model(Song, :find_by, not_found_terminus: true)
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div></div>

<p class="">When running the <code class="text-purple">Update</code> activity with an invalid ID, it terminates on <code class="text-purple">End.not_found</code>.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">signal, (ctx, _) = Trailblazer::Activity.(Song::Activity::Update, params: {id: nil})
puts signal #=&gt; #&lt;Trailblazer::Activity::End semantic=:not_found&gt;
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">result = Song::Operation::Update.(params: {id: nil})
result.success? # =&gt; false
</code></pre></div></div>

<h4 id="macro-model-model-dependency-injection" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Dependency Injection</span>

                  </h4>

<p class="">The following <code class="text-purple">Model()</code> options can be injected using variables when <code class="text-purple">call</code>ing the operation.</p>

<ul class="space-y-2">
  <li class="list-image-disc ml-10"><code class="text-purple">:"model.class"</code> which represents the first argument for <code class="text-purple">Model()</code>.</li>
  <li class="list-image-disc ml-10"><code class="text-purple">:"model.action"</code> representing the second argument.</li>
  <li class="list-image-disc ml-10"><code class="text-purple">:"model.find_by_key"</code> which represents the third argument.</li>
</ul>

<p class="">As per your design, you may inject one or more of those variables as follows.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">signal, (ctx, _) = Trailblazer::Activity.(Song::Activity::Create,
  params:               {title: "Olympia"}, # some random variable.
  "model.class":        Hit,
  "model.action":       :find_by,
  "model.find_by_key":  :title, seq: []
)
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">result = Song::Operation::Create.(
  params:               {title: "Olympia"}, # some random variable.
  "model.class":        Hit,
  "model.action":       :find_by,
  "model.find_by_key":  :title, seq: []
)
</code></pre></div></div>

<p class="">You can even leave <code class="text-purple">Model()</code> entirely unconfigured.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step Model()
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Create &lt; Trailblazer::Operation
    step Model()
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
</code></pre></div></div>

<p class="">This implies you inject all required variables at run-time.</p>

<h4 id="macro-model-model-model-class" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Model
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Model class</span>

                  </h4>

<p class="">Usually, the specific model class for <code class="text-purple">Model()</code> is set directly in the macro.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step Model(Song, :new)
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">module Song::Operation
  class Create &lt; Trailblazer::Operation
    step Model(Song, :new)
    step :validate
    step :save
    include T.def_steps(:validate, :save)
  end
end
</code></pre></div></div>

<p class="">Nevertheless, it’s possible to override it using the <code class="text-purple">:"model.class"</code> variable when invoking the operation/activity.</p>

<div class="spacing-y-0"><div class="spacing-x-1 mb-[6px]">
            <a href="#" data-toggle="code-tab" data-type="code-tab-activity">
              <span class="font-semi-bold bg-bg-purple-1 p-2 rounded-t" data-show="code-tab-activity" data-hide="code-tab-operation" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Activity</span>
            </a>
            <a href="#" data-toggle="code-tab" data-type="code-tab-operation">
              <span class="font-semi-bold bg-[#E4E4E4] p-2 rounded-t" data-show="code-tab-operation" data-hide="code-tab-activity" data-show-color="bg-bg-purple-1" data-hide-color="bg-[#E4E4E4]">Operation</span>
            </a>
          </div><div class="code-tab-activity code-tab-content"><pre class=""><code class="rounded-tr rounded-b">signal, (ctx, _) = Trailblazer::Activity.(Song::Activity::Create, params: {}, :"model.class" =&gt; Hit)
</code></pre></div><div class="code-tab-operation code-tab-content hidden"><pre class=""><code class="rounded-tr rounded-b">result = Song::Operation::Create.(params: {}, :"model.class" =&gt; Hit)
</code></pre></div></div>

<p class="">Note that you <a href="" class="underline text-purple">don’t have  to configure</a> any model class at all when injecting it.</p>


<h2 id="macro-rescue" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center">Rescue</h2>

<p class="">While you could be implementing your own <code class="text-purple">begin/rescue/end</code> mechanics using <a href="#wrap" class="underline text-purple"><code class="text-purple">Wrap</code></a>, Trailblazer offers you the <code class="text-purple">Rescue()</code> macro to catch and handle exceptions that might occur while running any series of steps.</p>

<pre class=""><code class="rounded">class Song::Activity::Create &lt; Trailblazer::Activity::Railway
  step :create_model
  step Rescue() {
    step :upload
    step :rehash
  }
  step :notify
  fail :log_error
  # ...
end
</code></pre>

<p class="">Any exception raised during a step in the <code class="text-purple">Rescue</code> block will cause the execution to stop, and continues after the block on the left (or <code class="text-purple">failure</code>) track.</p>

<h3 id="macro-rescue-options" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Options</h3>

<p class="">You can specify what particular exceptions to catch and an optional handler that is called when an exception is encountered.</p>

<pre class=""><code class="rounded">class Song::Activity::Create &lt; Trailblazer::Activity::Railway
  step :create_model
  step Rescue(RuntimeError, handler: MyHandler) {
    step :upload
    step :rehash
  }
  step :notify
  fail :log_error
  # ...
end
</code></pre>

<p class="">The handler’s <code class="text-purple">#call</code> method receives the exception and the circuit-interface arguments.</p>

<pre class=""><code class="rounded">class MyHandler
  def self.call(exception, (ctx), *)
    ctx[:exception_class] = exception.class
  end
end
</code></pre>

<p class="">Alternatively, you can use a  <code class="text-purple">Callable</code> object for <code class="text-purple">:handler</code>.</p>

<h3 id="macro-rescue-full-example" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Full example</h3>

<p class="">The  <code class="text-purple">Nested</code>, <code class="text-purple">Wrap</code> and <code class="text-purple">Rescue</code> macros can also be nested, allowing an easily extendable business workflow with error handling along the way.</p>

<p class="">TODO: add example</p>

<h2 id="macro-policy" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center">Policy</h2>

<p class="">The <code class="text-purple">Policy</code> macros <a href="#pundit" class="underline text-purple"><code class="text-purple">Policy::Pundit</code></a>, and <a href="#guard" class="underline text-purple"><code class="text-purple">Policy::Guard</code></a> help to implement permission decider steps.</p>

<h3 id="macro-policy-pundit" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Pundit</h3>

<p class="">The <code class="text-purple">Policy::Pundit</code> module allows using <a href="https://github.com/elabs/pundit" class="underline text-purple">Pundit</a>-compatible policy classes in an operation.</p>

<p class="">A Pundit policy has various rule methods and a special constructor that receives the current user and the current model.</p>

<pre class=""><code class="rounded">class MyPolicy
  def initialize(user, model)
    @user, @model = user, model
  end

  def create?
    @user == Module &amp;&amp; @model.id.nil?
  end

  def new?
    @user == Class
  end
end
</code></pre>

<p class="">In pundit policies, it is a convention to have access to those objects at runtime and build rules on top of those.</p>

<p class="">You can plug this policy into your pipe at any point. However, this must be inserted after the <code class="text-purple">"model"</code> skill is available.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Policy::Pundit( MyPolicy, :create? )
  # ...
end
</code></pre>

<p class="">Note that you don’t have to create the model via the <code class="text-purple">Model</code> macro - you can use any logic you want. The <code class="text-purple">Pundit</code> macro will grab the model from <code class="text-purple">["model"]</code>, though.</p>

<p class="">This policy will only pass when the operation is invoked as follows.</p>

<pre class=""><code class="rounded">
Create.(current_user: User.find(1))</code></pre>

<p class="">Any other call will cause a policy breach and stop the pipe from executing after the <code class="text-purple">Policy::Pundit</code> step.</p>

<h4 id="macro-policy-pundit-api" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Pundit
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">API</span>

                  </h4>

<p class="">Add your polices using the <code class="text-purple">Policy::Pundit</code> macro. It accepts the policy class name, and the rule method to call.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Policy::Pundit( MyPolicy, :create? )
  # ...
end
</code></pre>

<p class="">The step will create the policy instance automatically for you and passes the <code class="text-purple">"model"</code> and the <code class="text-purple">"current_user"</code> skill into the policies constructor. Just make sure those dependencies are available before the step is executed.</p>

<p class="">If the policy returns <code class="text-purple">falsey</code>, it <a href="api.html#flow-control-step" class="underline text-purple">deviates to the left track</a>.</p>

<p class="">After running the <code class="text-purple">Pundit</code> step, its result is readable from the <code class="text-purple">Result</code> object.</p>

<pre class=""><code class="rounded">result = Create.(params: {}, current_user: Module)
result[:"result.policy.default"].success? #=&gt; true
result[:"result.policy.default"][:policy] #=&gt; #&lt;MyPolicy ...&gt;
</code></pre>

<p class="">Note that the actual policy instance is available via <code class="text-purple">["result.policy.#{name}"]["policy"]</code> to be reinvoked with other rules (e.g. in the view layer).</p>

<h4 id="macro-policy-pundit-name" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Pundit
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Name</span>

                  </h4>

<p class="">You can add any number of Pundit policies to your pipe. Make sure to use <code class="text-purple">name:</code> to name them, though.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Policy::Pundit( MyPolicy, :create?, name: "after_model" )
  # ...
end
</code></pre>

<p class="">The result will be stored in <code class="text-purple">"result.policy.#{name}"</code></p>

<pre class=""><code class="rounded">result = Create.(params: {}, current_user: Module)
result[:"result.policy.after_model"].success? #=&gt; true
</code></pre>

<h4 id="macro-policy-pundit-dependency-injection" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Pundit
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Dependency Injection</span>

                  </h4>

<p class="">Override a configured policy using dependency injection.</p>

<pre class=""><code class="rounded">Create.(params: {},
  current_user:            Module,
  :"policy.default.eval" =&gt; Trailblazer::Operation::Policy::Pundit.build(AnotherPolicy, :create?)
)
</code></pre>

<p class="">You can inject it using <code class="text-purple">"policy.#{name}.eval"</code>. It can be any object responding to <code class="text-purple">call</code>.</p>

<h3 id="macro-policy-guard" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Guard</h3>

<p class="">A guard is a step that helps you evaluating a condition and writing the result. If the condition was evaluated as <code class="text-purple">falsey</code>, the pipe won’t be further processed and a policy breach is reported in <code class="text-purple">Result["result.policy.default"]</code>.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation
  step Policy::Guard(-&gt;(options, pass:, **) { pass })
  step :process

  def process(options, **)
    options[:x] = true
  end
end
</code></pre>

<p class="">The only way to make the above operation invoke the second step <code class="text-purple">:process</code> is as follows.</p>

<pre class=""><code class="rounded">
result = Create.({ pass: true })
result["x"] #=&gt; true</code></pre>

<p class="">Any other input will result in an abortion of the pipe after the guard.</p>

<pre class=""><code class="rounded">
result = Create.()
result["x"] #=&gt; nil
result["result.policy.default"].success? #=&gt; false</code></pre>

<p class="">Learn more about <a href="skill.md" class="underline text-purple">→ dependency injection</a> to pass params and current user into the operation. TODO: fix link</p>

<h4 id="macro-policy-guard-api" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Guard
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">API</span>

                  </h4>

<p class="">The <code class="text-purple">Policy::Guard</code> macro helps you inserting your guard logic. If not defined, it will be evaluated <a href="#guard-position" class="underline text-purple">where you insert</a> it.</p>

<pre class=""><code class="rounded">step :process

def process(options, **)
  options[:x] = true
end
</code></pre>

<p class="">The <code class="text-purple">options</code> object is passed into the guard and allows you to read and inspect data like <code class="text-purple">params</code> or <code class="text-purple">current_user</code>. Please use kw args.</p>

<h4 id="macro-policy-guard-callable" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Guard
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Callable</span>

                  </h4>

<p class="">As always, the guard can also be a <code class="text-purple">Callable</code>-marked object.</p>

<pre class=""><code class="rounded">class MyGuard
  def call(options, pass:, **)
    pass
  end
end
</code></pre>

<p class="">Insert the object instance via the <code class="text-purple">Policy::Guard</code> macro.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation
  step Policy::Guard( MyGuard.new )
  step :process

  # ...
end
</code></pre>

<h4 id="macro-policy-guard-instance-method" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Guard
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Instance Method</span>

                  </h4>

<p class="">As always, you may also use an instance method to implement a guard.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation
  step Policy::Guard( :pass? )

  def pass?(options, pass:, **)
    pass
  end
  step :process
  # ...
end
</code></pre>

<h4 id="macro-policy-guard-name" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Guard
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Name</span>

                  </h4>

<p class="">The guard name defaults to <code class="text-purple">default</code> and can be set via <code class="text-purple">name:</code>. This allows having multiple guards.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation
  step Policy::Guard( -&gt;(options, current_user:, **) { current_user }, name: :user )
  # ...
end
</code></pre>

<p class="">The result will sit in <code class="text-purple">result.policy.#{name}</code>.</p>

<pre class=""><code class="rounded">result = Create.(:current_user =&gt; true)
result[:"result.policy.user"].success? #=&gt; true
</code></pre>

<h4 id="macro-policy-guard-dependency-injection" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Guard
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Dependency Injection</span>

                  </h4>

<p class="">Instead of using the configured guard, you can inject any callable object that returns a <code class="text-purple">Result</code> object. Do so by overriding the <code class="text-purple">policy.#{name}.eval</code> path when calling the operation.</p>

<pre class=""><code class="rounded">Create.(
  :current_user           =&gt; Module,
  :"policy.default.eval"  =&gt; Trailblazer::Operation::Policy::Guard.build(-&gt;(options, **) { false })
)
</code></pre>

<p class="">An easy way to let Trailblazer build a compatible object for you is using <code class="text-purple">Guard.build</code>.</p>

<p class="">This is helpful to override a certain policy for testing, or to invoke it with special rights, e.g. for an admin.</p>

<h4 id="macro-policy-guard-position" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Guard
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Position</span>

                  </h4>

<p class="">You may specify a position.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation
  step :model!
  step Policy::Guard( :authorize! ),
    before: :model!
end
</code></pre>

<p class="">Resulting in the guard inserted before <code class="text-purple">model!</code>, even though it was added at a later point.</p>

<pre class=""><code class="rounded">  Trailblazer::Developer.railway(Create, style: :rows) #=&gt;
   # 0 ========================&gt;operation.new
   # 1 ==================&gt;policy.default.eval
   # 2 ===============================&gt;model!
</code></pre>

<p class="">This is helpful if you maintain modules for operations with generic steps.</p>

<h2 id="macro-contract" class="text-2xl font-bold text-neutral-500 lg:text-3xl py-2 flex items-center">Contract</h2>

<p class="">A <em>contract</em> is an abstraction to handle validation of arbitrary data or object state. It is a fully self-contained object that is orchestrated by the operation.</p>

<p class="">The actual validation can be implemented using Reform with <code class="text-purple">ActiveModel::Validation</code> or dry-validation, or a <a href="/2.1/docs/operation.html#operation-contract-dry-schema" class="underline text-purple"><code class="text-purple">Dry::Schema</code> directly</a> without Reform.</p>

<p class="">The <code class="text-purple">Contract</code> macros helps you defining contracts and assists with instantiating and validating data with those contracts at runtime.</p>

<h3 id="macro-contract-overview-reform" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">overview: reform</h3>

<p class="">Most contracts are <a href="/2.1/docs/reform.html" class="underline text-purple">Reform</a> objects that you can define and validate in the operation. Reform is a fantastic tool for deserializing and validating deeply nested hashes, and then, when valid, writing those to the database using your persistence layer such as ActiveRecord.</p>

<pre class=""><code class="rounded"># app/concepts/song/contract/create.rb
module Song::Contract
  class Create &lt; Reform::Form
    property :title
    property :length

    validates :title,  length: 2..33
    validates :length, numericality: true
  end
end
</code></pre>

<p class="">The contract then gets hooked into the operation.</p>

<pre class=""><code class="rounded">class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate()
  step Contract::Persist()
end
</code></pre>

<p class="">As you can see, using contracts consists of five steps.</p>

<ol>
  <li class="list-image-disc ml-10">Define the contract class (or multiple of them) for the operation.</li>
  <li class="list-image-disc ml-10">Plug the contract creation into the operation’s pipe using <code class="text-purple">Contract::Build</code>.</li>
  <li class="list-image-disc ml-10">Run the contract’s validation for the params using <code class="text-purple">Contract::Validate</code>.</li>
  <li class="list-image-disc ml-10">If successful, write the sane data to the model(s). This will usually happen in the <code class="text-purple">Contract::Persist</code> macro.</li>
  <li class="list-image-disc ml-10">After the operation has been run, <a href="/2.1/docs/operation.html#operation-overview-result" class="underline text-purple">interpret the result</a>. For instance, a controller calling an operation will render a erroring form for invalid input.</li>
</ol>

<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">You don’t have to use any of the TRB macros to deal with contracts, and do everything yourself. They are an abstraction that will save code and bugs, and introduce strong conventions. However, feel free to use your own code.</p>

  </div>
</div>

<p class="">Here’s what the result would look like after running the <code class="text-purple">Create</code> operation with invalid data.</p>

<pre class=""><code class="rounded">result = Song::Create.(params: { title: "A" })
result.success? #=&gt; false
result[:"contract.default"].errors.messages
#=&gt; {:title=&gt;["is too short (minimum is 2 characters)"], :length=&gt;["is not a number"]}
</code></pre>

<h3 id="macro-contract-definition" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Definition</h3>

<p class="">Trailblazer offers a few different ways to define contract classes and use them in an operation.</p>

<h4 id="macro-contract-definition-explicit" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Definition
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Explicit</span>

                  </h4>

<p class="">The preferred way of defining contracts is to use a separate file and class, such as the example below.</p>

<pre class=""><code class="rounded"># app/concepts/song/contract/create.rb
module Song::Contract
  class Create &lt; Reform::Form
    property :title
    property :length

    validates :title,  length: 2..33
    validates :length, numericality: true
  end
end
</code></pre>

<p class="">This is called <em>explicit contract</em>.</p>

<p class="">The contract file could be located just anywhere, but it’s clever to follow the Trailblazer conventions.</p>

<p class="">Using the contract happens via <code class="text-purple">Contract::Build</code>, and the <code class="text-purple">:constant</code> option.</p>

<pre class=""><code class="rounded">class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate()
  step Contract::Persist()
end
</code></pre>

<p class="">Since both operations and contracts grow during development, the completely encapsulated approach of the explicit contract is what we recommend.</p>

<h4 id="macro-contract-definition-inline" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Definition
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Inline</span>

                  </h4>

<p class="">Contracts can also be defined in the operation itself.</p>

<pre class=""><code class="rounded"># app/concepts/song/create.rb
class Create &lt; Trailblazer::Operation
  class MyContract &lt; Reform::Form
    property :title
    property :length

    validates :title,  presence: true
    validates :length, numericality: true
  end

  step Model( Song, :new )
  step Contract::Build(constant: MyContract)
  step Contract::Validate()
  step Contract::Persist( method: :sync )
end
</code></pre>

<p class="">Defining the contract happens via the <code class="text-purple">contract</code> block. This is called an <em>inline contract</em>. Note that you need to extend the class with the <code class="text-purple">Contract::DSL</code> module. You don’t have to specify anything in the <code class="text-purple">Build</code> macro.</p>

<p class="">While this is nice for a quick example, this usually ends up quite convoluted and we advise you to use the <a href="/2.1/docs/operation.html#operation-contract-definition-explicit" class="underline text-purple">explicit style</a>.</p>

<h3 id="macro-contract-build" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Build</h3>

<p class="">The <code class="text-purple">Contract::Build</code> macro helps you to instantiate the contract.
It is both helpful for a complete workflow, or to create the contract, only, without validating it, e.g. when presenting the form.</p>

<pre class=""><code class="rounded">class Song::New &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
end
</code></pre>

<p class="">This macro will grab the model from <code class="text-purple">options["model"]</code> and pass it into the contract’s constructor. The contract is then saved in <code class="text-purple">options["contract.default"]</code>.</p>

<pre class=""><code class="rounded">result = Song::New.(params: {})
result["model"] #=&gt; #&lt;struct Song title=nil, length=nil&gt;
result["contract.default"]
#=&gt; #&lt;Song::Contract::Create model=#&lt;struct Song title=nil, length=nil&gt;&gt;
</code></pre>

<p class="">The <code class="text-purple">Build</code> macro accepts <a href="/2.1/docs/operation.html#operation-contract-name" class="underline text-purple">the <code class="text-purple">:name</code> option</a> to change the name from <code class="text-purple">default</code>.</p>

<h4 id="macro-contract-build-dependency-injection-contract-class" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Build
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Dependency Injection / Contract class</span>

                  </h4>

<p class="">Instead of defining  the contract class in the <code class="text-purple">Build()</code> macro the very option can be injected at run-time, when <code class="text-purple">call</code>ing the operation. The operation <em>class</em> doesn’t need any hard-wired reference to a contract class at all.</p>

<pre class=""><code class="rounded">class Song::Create &lt; Trailblazer::Operation
  step Model(Song, :new)
  step Contract::Build() # no constant provided here!
  step Contract::Validate()
  step Contract::Persist(method: :sync)
end
</code></pre>

<p class="">A prerequisite for that is that the contract class is defined somewhere.</p>

<pre class=""><code class="rounded">class MyContract &lt; Reform::Form
  property :title
  validates :title, length: 2..33
end
</code></pre>

<p class="">When invoking the operation, you now have to provide the default contract class as a variable (or dependency) using the <code class="text-purple">:"contract.default.class"</code> option. The <code class="text-purple">Build()</code> step will use the passed class constant for instantiating the contract.</p>

<pre class=""><code class="rounded">Song::Create.(
  params:                   { title: "Anthony's Song" },
  "contract.default.class": MyContract # dependency injection!
)
</code></pre>

<p class="">This will work with any contract name if you follow <a href="/2.1/docs/operation.html#operation-contract-name" class="underline text-purple">the naming conventions</a>.</p>

<h3 id="macro-contract-validate" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Validate</h3>

<p class="">The <code class="text-purple">Contract::Validate</code> macro is responsible for validating the incoming params against its contract. That means you have to use <code class="text-purple">Contract::Build</code> beforehand, or create the contract yourself. The macro will then grab the params and throw then into the contract’s <code class="text-purple">validate</code> (or <code class="text-purple">call</code>) method.</p>

<pre class=""><code class="rounded">class Song::ValidateOnly &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate()
end
</code></pre>

<p class="">Depending on the outcome of the validation, it either stays on the right track, or deviates to left, skipping the remaining steps.</p>

<pre class=""><code class="rounded">result = Song::ValidateOnly.(params: {}) # empty params
result.success? #=&gt; false
</code></pre>

<p class="">Note that <code class="text-purple">Validate</code> really only validates the contract, nothing is written to the model, yet. You need to push data to the model manually, e.g. <a href="/2.1/docs/operation.html#operation-contract-persist" class="underline text-purple">with <code class="text-purple">Contract::Persist</code></a>.</p>

<pre class=""><code class="rounded">result = Song::ValidateOnly.(params: { title: "Rising Force", length: 13 })

result.success? #=&gt; true
result[:model] #=&gt; #&lt;struct Song title=nil, length=nil&gt;
result[:"contract.default"].title #=&gt; "Rising Force"
</code></pre>

<p class=""><code class="text-purple">Validate</code> will use <code class="text-purple">options["params"]</code> as the input. You can change the nesting with <a href="/2.1/docs/operation.html#operation-contract-key" class="underline text-purple">the <code class="text-purple">:key</code> option</a>.</p>

<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">Internally, this macro will simply call <code class="text-purple">Form#validate</code> on the Reform object.</p>

<p class="">Note that Reform comes with sophisticated deserialization semantics for nested forms, it might be worth reading <a href="/2.1/docs/reform.html" class="underline text-purple">a bit about Reform</a> to fully understand what you can do in the <code class="text-purple">Validate</code> step.</p>

  </div>
</div>

<h4 id="macro-contract-validate-key" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Validate
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Key</span>

                  </h4>

<p class="">Per default, <code class="text-purple">Contract::Validate</code> will use <code class="text-purple">ctx[:params]</code> as the data to be validated. Use the <code class="text-purple">:key</code> option if you want to validate a nested hash from the original params structure.</p>

<pre class=""><code class="rounded">class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate( key: "song" )
  step Contract::Persist( )
end
</code></pre>

<p class="">This automatically extracts the nested <code class="text-purple">"song"</code> hash.</p>

<pre class=""><code class="rounded">result = Song::Create.(params: { "song" =&gt; { title: "Rising Force", length: 13 } })
result.success? #=&gt; true
</code></pre>

<p class="">If that key isn’t present in the params hash, the operation fails before the actual validation.</p>

<pre class=""><code class="rounded">result = Song::Create.(params: { title: "Rising Force", length: 13 })
result.success? #=&gt; false
</code></pre>

<p class="">Note that string vs. symbol do matter here since the operation will simply do a hash lookup using the key you provided.</p>

<h4 id="macro-contract-validate-dependency-injection-key" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Validate
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Dependency Injection / Key</span>

                  </h4>

<p class="">The <code class="text-purple">Validate()</code> macro allows to injecting the <code class="text-purple">:key</code> option at run-time instead of providing it when using the macro on the class level. You may omit the <code class="text-purple">:key</code> option in the <code class="text-purple">Validate()</code> macro call as below.</p>

<pre class=""><code class="rounded">class Song::Create &lt; Trailblazer::Operation
  # ...
  step Contract::Validate() # we don't define a key here! E.g. {key: "song"}
  step Contract::Persist()
end
</code></pre>

<p class="">Defining the <code class="text-purple">:key</code> option in <code class="text-purple">Operation.call</code> is now achieved by passing the <code class="text-purple">"contract.default.extract_key"</code> option.</p>
<pre class=""><code class="rounded">res = Song::Create.(
  params:                         params,
  "contract.default.extract_key": "song"
)
</code></pre>

<p class="">Note that the <code class="text-purple">.default</code> part might differ depending on the name of your contract.</p>

<h4 id="macro-contract-validate-dependency-injection-contract-instance" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Validate
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Dependency injection / Contract instance</span>

                  </h4>

<p class="">Instead of using <code class="text-purple">Contract::Build()</code> to let the macro create the contract instance used for <code class="text-purple">Validate()</code>, an arbitrary contract object may be injected at run-time. You may omit <code class="text-purple">Model()</code> and <code class="text-purple">Contract::Build()</code> in that case.</p>

<pre class=""><code class="rounded">class Song::Create &lt; Trailblazer::Operation
  # we omit the {Model()} call as the run-time contract contains the model.
  # we don't have a {Contract::Build()} step here.
  step Contract::Validate(key: "song") # you could use an injection here, too!
  step Contract::Persist()
end
</code></pre>

<p class="">In order for <code class="text-purple">Validate()</code> to work you have to inject a contract via the <code class="text-purple">:"contract.default"</code> option.</p>

<pre class=""><code class="rounded">res = Song::Create.(
  params:             params,
  "contract.default": Song::Contract::Create.new(Song.new) # we build the contract ourselves!
)
</code></pre>

<p class="">As always, the <code class="text-purple">.default</code> part might differ depending on the name of your contract.</p>

<h3 id="macro-contract-invalid-termini" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Invalid Termini</h3>

<p class="">If the <code class="text-purple">Contract::Validate()</code> deviates on a failure track, it is possible to emit a new <a href="/2.1/docs/operation.html#signals" class="underline text-purple">signal</a> suggesting contract failure.</p>

<p class=""><img class="mt-12 mb-12 mx-auto" src="/assets/macro-ends-8e75c9c39d382355ec12839bcdefc132ad63ebbcdad1384b96de831f850732ae.webp" /></p>

<p class="">This becomes really handy when used along with the <a href="/2.1/docs/endpoint.html" class="underline text-purple">endpoint</a>.
It avoids any conditional checks and can be wired to render <strong>422 response</strong> without accessing the <code class="text-purple">ctx</code>.
In order to add this <a href="/2.1/docs/activity.html#activity-wiring-api-end-adding-ends" class="underline text-purple">new termini</a> in your operation’s terminuses, you need to pass <code class="text-purple">invalid_data_terminus</code> kwarg.</p>

<pre class=""><code class="rounded">class Song::Create &lt; Trailblazer::Operation
  step Model(Song, :new)
  step Contract::Build(constant: Song::Contract::Create)
  step Contract::Validate(key: :song, invalid_data_terminus: true)
  step Contract::Persist()
end
</code></pre>

<p class="">Based on the given <a href="/2.1/docs/operation.html#operation-contract-name" class="underline text-purple">name</a> to this macro (default is ofcourse, <code class="text-purple">default</code>), it will assign <code class="text-purple">End</code> semantic as <code class="text-purple">"contract.#{name}.invalid"</code>.</p>

<pre class=""><code class="rounded">result = Song::Create.(params: { title: "Rising Force", length: 13 })
result.success? #=&gt; false
result.event    #=&gt; #&lt;Trailblazer::Activity::End semantic=:"contract.default.invalid"&gt;
</code></pre>

<h3 id="macro-contract-persist" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Persist</h3>

<p class="">To push validated data from the contract to the model(s), use <code class="text-purple">Persist</code>. Like <code class="text-purple">Validate</code>, this requires a contract to be set up beforehand.</p>

<pre class=""><code class="rounded">class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate()
  step Contract::Persist()
end
</code></pre>

<p class="">After the step, the contract’s attribute values are written to the model, and the contract will call <code class="text-purple">save</code> on the model.</p>

<pre class=""><code class="rounded">result = Song::Create.(params: { title: "Rising Force", length: 13 })
result.success? #=&gt; true
result["model"] #=&gt; #&lt;Song title="Rising Force", length=13&gt;
</code></pre>

<p class="">You can also configure the <code class="text-purple">Persist</code> step to call <code class="text-purple">sync</code> instead of Reform’s <code class="text-purple">save</code>.</p>

<pre class=""><code class="rounded">
step Persist( method: :sync )</code></pre>

<p class="">This will only write the contract’s data to the model without calling <code class="text-purple">save</code> on it.</p>

<h3 id="macro-contract-name" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Name</h3>

<p class="">Explicit naming for the contract is possible, too.</p>

<pre class=""><code class="rounded">class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build(    name: "form", constant: Song::Contract::Create )
  step Contract::Validate( name: "form" )
  step Contract::Persist(  name: "form" )
end
</code></pre>

<p class="">You have to use the <code class="text-purple">name:</code> option to tell each step what contract to use. The contract and its result will now use your name instead of <code class="text-purple">default</code>.</p>

<pre class=""><code class="rounded">result = Song::Create.(params: { title: "A" })
result[:"contract.form"].errors.messages #=&gt; {:title=&gt;["is too short (minimum is 2 ch...
</code></pre>

<p class="">Use this if your operation has multiple contracts.</p>

<h3 id="macro-contract-dry-validation" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Dry-Validation</h3>

<p class="">Instead of using <code class="text-purple">ActiveModel::Validation</code> you may use the very popular <a href="http://dry-rb.org/gems/dry-validation/" class="underline text-purple"><code class="text-purple">dry-validation</code> gem</a> for  validations in your Reform class.</p>

<pre class=""><code class="rounded">require "reform/form/dry"
class Create &lt; Trailblazer::Operation
  # contract to verify params formally.
  class MyContract &lt; Reform::Form
    feature Dry
    property :id
    property :title

    validation name: :default do
      params do
        required(:id).filled
      end
    end

    validation name: :extra, if: :default do
      params do
        required(:title).filled(min_size?: 2)
      end
    end
  end

  step Model( Song, :new )                      # create the op's main model.
  step Contract::Build( constant: MyContract )  # create the Reform contract.
  step Contract::Validate()                     # validate the Reform contract.
  step Contract::Persist( method: :sync)        # persist the contract's data via the model.
end
</code></pre>

<p class="">All you need to do is including the <code class="text-purple">feature Dry</code> extension and applying dry-validation’s syntax within the <code class="text-purple">validation</code> blocks. The operation’s macros will work seamlessly with dry’s logic.</p>

<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">(TODO Jan 2021) We are rewriting the Dry-validation documentation shortly and will link to a more concise reference here.</p>

  </div>
</div>

<h4 id="macro-contract-dry-validation-dry-schema" class="font-bold text-neutral-500 lg:text-1xl text-xl py-2">Dry-Validation
                  <span class="text-purple bg-lighter-purple p-2 rounded font-medium">Dry-Schema</span>

                  </h4>

<p class="">It is possible to use Dry’s <a href="http://dry-rb.org/gems/dry-validation/" class="underline text-purple">Validation::Contract</a> directly as a contract in an operation, using the <code class="text-purple">Contract::Validate()</code> macro. You don’t need a model here, and the contract cannot be persisted. However, this is great for formal validations, e.g. to make sure the params have the correct format.</p>

<pre class=""><code class="rounded">module Song::Operation
  class Archive &lt; Trailblazer::Operation
    Schema = Dry::Validation.Contract do
      params do
        required(:id).filled
      end
    end

    # step Model(Song, :new)                              # You don't need {ctx[:model]}.
    step Contract::Validate(constant: Schema, key: :song) # Your validation.
    # ...
  end
end
</code></pre>

<p class="">Invoking the operation works exactly as it did with a “normal” contract.</p>

<pre class=""><code class="rounded">result = Song::Operation::Archive.(params: {song: {id: nil}})
</code></pre>

<p class="">Note that if you don’t use the <code class="text-purple">:song</code> key in your incoming data, you can <a href="/2.1/docs/operation.html#operation-contract-validate-key" class="underline text-purple">configure</a> the <code class="text-purple">Validate()</code> macro to refrain from looking for that key.</p>

<p class="">The “errors” object after running the contract validation can be found at `ctx[:”result.contract.default”]</p>

<pre class=""><code class="rounded">result[:"result.contract.default"].errors[:id] #=&gt; ["must be filled"]
</code></pre>

<div class="rounded flex p-4 gap-4 bg-bg-purple-1/50">
  <img src="/assets/info_icon-faf751d86d27155660995d9f129cfd3b63ce05a3a91e1acdda7d214f55bdb347.svg" />
  <div class="space-y-3">
    
<p class="">(TODO Jan 2021) We are working on an operation-wide <code class="text-purple">Errors</code> object which will be available at <code class="text-purple">ctx[:errors]</code>.</p>

  </div>
</div>

<h3 id="macro-contract-manual-extraction" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Manual Extraction</h3>

<p class="">You can plug your own complex logic to extract params for validation into the pipe.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation
  class MyContract &lt; Reform::Form
    property :title
  end

  def type
    "evergreen" # this is how you could do polymorphic lookups.
  end

  step Model( Song, :new )
  step Contract::Build(constant: MyContract)
  step :extract_params!
  step Contract::Validate( skip_extract: true )
  step Contract::Persist( method: :sync )

  def extract_params!(options, **)
    options[:"contract.default.params"] = options[:params][type]
  end
end
</code></pre>

<p class="">Note that you have to set the <code class="text-purple">self["params.validate"]</code> field in your own step, and - obviously - this has to happen before the actual validation.</p>

<p class="">Keep in mind that <code class="text-purple">&amp;</code> will deviate to the left track if your <code class="text-purple">extract_params!</code> logic returns falsey.</p>

<h3 id="macro-contract-manual-build" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Manual Build</h3>

<p class="">To manually build the contract instance, e.g. to inject the current user, use <code class="text-purple">builder:</code>.</p>

<pre class=""><code class="rounded">class Create &lt; Trailblazer::Operation

  class MyContract &lt; Reform::Form
    property :title
    property :current_user, virtual: true

    validate :current_user?
    validates :title, presence: true

    def current_user?
      return true if defined?(current_user)
      false
    end
  end

  step Model( Song, :new )
  step Contract::Build( constant: MyContract, builder: :default_contract! )
  step Contract::Validate()
  step Contract::Persist( method: :sync )

  def default_contract!(options, constant:, model:, **)
    constant.new(model, current_user: options [:current_user])
  end
end
</code></pre>

<p class="">Note how the contract’s class and the appropriate model are offered as kw arguments. You’re free to ignore these options and use your own assets.</p>

<p class="">As always, you may also use a proc.</p>

<h3 id="macro-contract-result-object" class="font-bold text-neutral-500 lg:text-2xl text-xl py-2 flex items-center">Result Object</h3>

<p class="">The operation will store the validation result for every contract in its own result object.</p>

<p class="">The path is <code class="text-purple">result.contract.#{name}</code>.</p>

<pre class=""><code class="rounded">result = Create.(params: { length: "A" })

result[:"result.contract.default"].success?        #=&gt; false
result[:"result.contract.default"].errors          #=&gt; Errors object
result[:"result.contract.default"].errors.messages #=&gt; {:length=&gt;["is not a number"]}

</code></pre>

<p class="">Each result object responds to <code class="text-purple">success?</code>, <code class="text-purple">failure?</code>, and <code class="text-purple">errors</code>, which is an <code class="text-purple">Errors</code> object. TODO: design/document Errors. WE ARE CURRENTLY WORKING ON A UNIFIED API FOR ERRORS (FOR DRY AND REFORM).</p>

        </div>

            <!-- 5.5rem is lg navbar height -->
        <div class="bg-white h-screen w-56 sticky top-[5.5rem]" id="right-toc">
          <div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-macro-overview">
  <h4 class="font-base font-bold leading-10 pl-2">
     Overview
  </h4>

  
    <a class="block px-2 leading-8" href="#macro-overview-general-notes">General notes</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-overview-general-notes-variable-mapping">Variable mapping</a>
    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-macro-nested">
  <h4 class="font-base font-bold leading-10 pl-2">
     Nested
  </h4>

  
    <a class="block px-2 leading-8" href="#macro-nested-dynamic">Dynamic</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-nested-dynamic-decider">Decider</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-nested-dynamic-nested-activity">Nested activity</a>
    
  
    <a class="block px-2 leading-8" href="#macro-nested-auto_wire">Auto_wire</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-nested-auto_wire-output-wiring">Output Wiring</a>
    
  
    <a class="block px-2 leading-8" href="#macro-nested-compliance">Compliance</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-nested-compliance-debugger">Debugger</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-nested-compliance-introspect">Introspect</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-nested-compliance-patch">Patch</a>
    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-macro-wrap">
  <h4 class="font-base font-bold leading-10 pl-2">
     Wrap
  </h4>

  
    <a class="block px-2 leading-8" href="#macro-wrap-wrap-handler">Wrap handler</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-wrap-wrap-handler-routing">Routing</a>
    
  
    <a class="block px-2 leading-8" href="#macro-wrap-transaction">Transaction</a>

    
  
    <a class="block px-2 leading-8" href="#macro-wrap-exception-handling">Exception handling</a>

    
  
    <a class="block px-2 leading-8" href="#macro-wrap-compliance">Compliance</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-wrap-compliance-debugger">Debugger</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-wrap-compliance-introspect">Introspect</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-wrap-compliance-patch">Patch</a>
    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-macro-each">
  <h4 class="font-base font-bold leading-10 pl-2">
     Each
  </h4>

  
    <a class="block px-2 leading-8" href="#macro-each-dataset_from">dataset_from</a>

    
  
    <a class="block px-2 leading-8" href="#macro-each-iterated-block">Iterated Block</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-each-iterated-block-item-key">item key</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-each-iterated-block-operation">operation</a>
    
  
    <a class="block px-2 leading-8" href="#macro-each-collect-option">Collect option</a>

    
  
    <a class="block px-2 leading-8" href="#macro-each-variable-mapping">Variable mapping</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-each-variable-mapping-filtering">Filtering</a>
    
  
    <a class="block px-2 leading-8" href="#macro-each-failure">Failure</a>

    
  
    <a class="block px-2 leading-8" href="#macro-each-compliance">Compliance</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-each-compliance-debugger">Debugger</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-each-compliance-introspect">Introspect</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-each-compliance-patch">Patch</a>
    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-macro-model">
  <h4 class="font-base font-bold leading-10 pl-2">
     Model
  </h4>

  
    <a class="block px-2 leading-8" href="#macro-model-model-find">Model::Find</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-find-find_by">Find_by</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-find-params_key">params_key</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-find-id_from">id_from</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-find-not-found">Not Found</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-find-find">find</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-find-debugging">Debugging</a>
    
  
    <a class="block px-2 leading-8" href="#macro-model-model-build">Model::Build</a>

    
  
    <a class="block px-2 leading-8" href="#macro-model-dependency-injection">Dependency Injection</a>

    
  
    <a class="block px-2 leading-8" href="#macro-model-model">Model</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-find_by">Find_by</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-key">Key</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-find">find</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-arbitrary-finder">Arbitrary Finder</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-not-found">Not Found</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-dependency-injection">Dependency Injection</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-model-model-model-class">Model class</a>
    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-macro-rescue">
  <h4 class="font-base font-bold leading-10 pl-2">
     Rescue
  </h4>

  
    <a class="block px-2 leading-8" href="#macro-rescue-options">Options</a>

    
  
    <a class="block px-2 leading-8" href="#macro-rescue-full-example">Full example</a>

    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-macro-policy">
  <h4 class="font-base font-bold leading-10 pl-2">
     Policy
  </h4>

  
    <a class="block px-2 leading-8" href="#macro-policy-pundit">Pundit</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-policy-pundit-api">API</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-policy-pundit-name">Name</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-policy-pundit-dependency-injection">Dependency Injection</a>
    
  
    <a class="block px-2 leading-8" href="#macro-policy-guard">Guard</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-policy-guard-api">API</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-policy-guard-callable">Callable</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-policy-guard-instance-method">Instance Method</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-policy-guard-name">Name</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-policy-guard-dependency-injection">Dependency Injection</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-policy-guard-position">Position</a>
    
  
</div>


<div class="display_none bg-white p-5 w-56 shrink-0 text-bg-blue overflow-y-scroll top-22" id="right-toc-macro-contract">
  <h4 class="font-base font-bold leading-10 pl-2">
     Contract
  </h4>

  
    <a class="block px-2 leading-8" href="#macro-contract-overview-reform">overview: reform</a>

    
  
    <a class="block px-2 leading-8" href="#macro-contract-definition">Definition</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-contract-definition-explicit">Explicit</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-contract-definition-inline">Inline</a>
    
  
    <a class="block px-2 leading-8" href="#macro-contract-build">Build</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-contract-build-dependency-injection-contract-class">Dependency Injection / Contract class</a>
    
  
    <a class="block px-2 leading-8" href="#macro-contract-validate">Validate</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-contract-validate-key">Key</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-contract-validate-dependency-injection-key">Dependency Injection / Key</a>
    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-contract-validate-dependency-injection-contract-instance">Dependency injection / Contract instance</a>
    
  
    <a class="block px-2 leading-8" href="#macro-contract-invalid-termini">Invalid Termini</a>

    
  
    <a class="block px-2 leading-8" href="#macro-contract-persist">Persist</a>

    
  
    <a class="block px-2 leading-8" href="#macro-contract-name">Name</a>

    
  
    <a class="block px-2 leading-8" href="#macro-contract-dry-validation">Dry-Validation</a>

    
      <a class="block px-2 pt-[.33rem] pb-[.33rem] leading-snug text-purple pl-6" href="#macro-contract-dry-validation-dry-schema">Dry-Schema</a>
    
  
    <a class="block px-2 leading-8" href="#macro-contract-manual-extraction">Manual Extraction</a>

    
  
    <a class="block px-2 leading-8" href="#macro-contract-manual-build">Manual Build</a>

    
  
    <a class="block px-2 leading-8" href="#macro-contract-result-object">Result Object</a>

    
  
</div>


        </div>
      </div>
    </div>
  </div>
</section>


<footer class="lg:text-left bg-bg-blue py-16 text-white text-center text-base">
  <div class="lg:flex justify-between w-11/12 max-w-[80rem] mx-auto">
    <div class="lg:flex lg:flex-col lg:justify-between">
      <a href="/2.1/" class="block shrink-0 w-fit mx-auto lg:mx-0" >
        <img class="w-48" src="/assets/logo_white_ruby-01c45713d0879788514c52d65ac53e92d7735b42cec0baf6e080b08f9a0fb595.svg" />
      </a>
      <div class="lg:block hidden">
        © 2023 Trailblazer GmbH
      </div>
    </div>
    <div class="lg:flex lg:gap-20 xl:gap-40">
      <div class="lg:mt-0 flex flex-col gap-5 mt-15">
        <a class="font-bold text-xl" href="#">Documentation</a>
        <a href="#">About</a>
        <a href="#">Community</a>
        <a href="#">Blog</a>
        <a href="#">Legal</a>
      </div>
      <div class="lg:mt-0 flex flex-col gap-5 mt-15">
        <a class="font-bold text-xl" href="#">Products</a>
        <a href="#">Trailblazer</a>
        <a href="#">Trailblazer Pro</a>
        <a href="#">Support</a>
      </div>
      <div class="lg:mt-0 flex flex-col gap-5 mt-15">
        <a class="font-bold text-xl" href="#">Learn</a>
        <a href="#">What is Trailblazer?</a>
        <a href="#">Trailblazer PRO</a>
        <a href="#">Tips and Tutorials</a>
        <a href="https://trailblazer.zulipchat.com">Chat</a>
      </div>
    </div>
  </div>
  <div class="lg:hidden mt-15">
    © 2023 Trailblazer GmbH
  </div>
</footer>


  </body>
</html>
